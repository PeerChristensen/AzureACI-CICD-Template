name: Deploy container registry and docker image

concurrency: container-deploy-workflow

env:
  RESOURCEGROUP_NAME: container-rg
  REGISTRY_NAME: container-acr

on: 
  push:
    branches: 
      - main
  workflow_dispatch:
      
jobs:
  vars:
    runs-on: ubuntu-latest
    outputs:
      resource_group: ${{ env.RESOURCEGROUP_NAME }}
      acr_name: ${{ env.REGISTRY_NAME }}
      creds: ${{ secrets.AZURE_CREDENTIALS_TEST }}
    steps:
      - run: echo "Exposing env vars"
  deploy-acr-test:
    needs: vars
    uses: ./.github/workflows/deploy_acr.yml
    if: github.ref == 'refs/heads/main'
    with:
      environment: Test
      resource_group: ${{ needs.vars.outputs.resource_group }}-test
      acr_name: ${{ needs.vars.outputs.acr_name }}-test
      creds: ${{ needs.vars.outputs.creds }}

#  deploy-acr-prod:
#    needs: deploy-acr-test
#    uses: ./.github/workflows/deploy_acr.yml
#    if: github.ref == 'refs/heads/main'
#    with:
#      environment: Prod
#      resource_group: ${{ env.RESOURCEGROUP_NAME }}-Prod
#      acr_name: ${{ env.REGISTRY_NAME }}-Prod
#      creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}
